<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Markets</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-item lines="none">
    <ion-label>
      <h2>Verfügbar</h2>
      <p>{{ cryptoCount }} Kryptos • {{ stockCount }} Aktien</p>
    </ion-label>
  </ion-item>

  <!-- Info-Hinweis (mittel) + Tooltip -->
  <ion-item lines="none" class="ion-margin-bottom">
    <ion-label>
      In dieser Ansicht zeigen wir alle verfügbaren Marktdaten aus unserer
      Datenbank an. Die Daten werden automatisch aus verschiedenen Quellen
      geladen und aktualisiert.
    </ion-label>
    <ion-button fill="clear" slot="end" id="info-tip">
      <ion-icon name="information-circle-outline"></ion-icon>
    </ion-button>
  </ion-item>
  <ion-popover trigger="info-tip" triggerAction="click">
    <ng-template>
      <ion-content class="ion-padding">
        Zeigt alle verfügbaren Marktdaten aus der Datenbank an, einschließlich
        Krypto, Aktien und andere Finanzinstrumente.
      </ion-content>
    </ng-template>
  </ion-popover>

  <ion-segment
    [(ngModel)]="selectedType"
    (ionChange)="onTypeFilterChange()"
    class="ion-margin-vertical"
  >
    <ion-segment-button value="all">Alle</ion-segment-button>
    <ion-segment-button value="crypto">Krypto</ion-segment-button>
    <ion-segment-button value="stock">Aktien</ion-segment-button>
  </ion-segment>

  <ion-item>
    <ion-label position="floating">Suche</ion-label>
    <ion-input
      [(ngModel)]="searchTerm"
      (ionChange)="onSearchChange()"
    ></ion-input>
  </ion-item>

  <ion-item lines="none" class="ion-margin-top">
    <ion-label>Sortieren nach</ion-label>
    <ion-segment (ionChange)="applyFilters()">
      <ion-segment-button value="nameAsc" (click)="sortBy='name'; sortDir='asc'"
        >Name ↑</ion-segment-button
      >
      <ion-segment-button
        value="nameDesc"
        (click)="sortBy='name'; sortDir='desc'"
        >Name ↓</ion-segment-button
      >
      <ion-segment-button
        value="priceAsc"
        (click)="sortBy='price'; sortDir='asc'"
        >Preis ↑</ion-segment-button
      >
      <ion-segment-button
        value="priceDesc"
        (click)="sortBy='price'; sortDir='desc'"
        >Preis ↓</ion-segment-button
      >
    </ion-segment>
  </ion-item>

  <ion-list class="list-tight border-main">
    <ion-item *ngFor="let asset of filteredAssets" (click)="goToDetail(asset)">
      <ion-label>
        <h3>{{ asset.name }}</h3>
        <p>{{ asset.symbol }}</p>
        <p *ngIf="asset.sourceId" class="source-info">
          <ion-icon name="information-circle-outline"></ion-icon>
          {{ asset.sourceId }}
        </p>
        <p *ngIf="asset.lastUpdated" class="update-info">
          <ion-icon name="time-outline"></ion-icon>
          {{ asset.lastUpdated | date:'short' }}
        </p>
      </ion-label>
      <div slot="end" class="price-info">
        <div class="price">{{ asset.price | number:'1.2-2' || 'N/A' }}</div>
        <div
          *ngIf="asset.priceChange !== undefined"
          class="price-change"
          [class.positive]="asset.priceChange >= 0"
          [class.negative]="asset.priceChange < 0"
        >
          {{ asset.priceChange >= 0 ? '+' : '' }}{{ asset.priceChange |
          number:'1.2-2' }} ({{ asset.priceChangePercent | number:'1.1-1' }}%)
        </div>
      </div>
    </ion-item>
  </ion-list>

  <!-- Keine Daten verfügbar -->
  <div *ngIf="!loading && filteredAssets.length === 0" class="no-data">
    <ion-icon
      name="alert-circle-outline"
      size="large"
      color="medium"
    ></ion-icon>
    <h3>Keine Marktdaten verfügbar</h3>
    <p>Es wurden keine gecachten Marktdaten in der Datenbank gefunden.</p>
    <p>Verwende die Debug-Buttons unten, um die Datenbank zu überprüfen.</p>
  </div>

  <!-- Optional detailliert (Modal/FAQ) -->
  <ion-button expand="block" fill="outline" id="faq-open" class="ion-margin-top box-shadow-off"
    >Mehr Infos</ion-button
  >

  <!-- Debug-Button (nur für Entwicklung) -->
  <ion-button
    expand="block"
    fill="clear"
    color="medium"
    class="ion-margin-top"
    (click)="debugAllCachedData()"
  >
    Debug: Alle gecachten Daten anzeigen
  </ion-button>

  <!-- Refresh-Button -->
  <ion-button
    expand="block"
    fill="outline"
    color="primary"
    class="ion-margin-top box-shadow-off"
    (click)="refreshData()"
    [disabled]="loading"
  >
    <ion-icon name="refresh-outline" slot="start"></ion-icon>
    {{ loading ? 'Aktualisiere...' : 'Daten aktualisieren' }}
  </ion-button>

  <!-- Test-Button -->
  <ion-button
    expand="block"
    fill="outline"
    color="secondary"
    class="ion-margin-top box-shadow-off"
    (click)="testFirestoreConnection()"
  >
    <ion-icon name="bug-outline" slot="start"></ion-icon>
    Firestore-Verbindung testen
  </ion-button>

  <!-- Collections überprüfen -->
  <ion-button
    expand="block"
    fill="outline"
    color="tertiary"
    class="ion-margin-top box-shadow-off"
    (click)="checkAllCollections()"
  >
    <ion-icon name="folder-outline" slot="start"></ion-icon>
    Alle Collections überprüfen
  </ion-button>

  <!-- Datenstruktur analysieren -->
  <ion-button
    expand="block"
    fill="outline"
    color="warning"
    class="ion-margin-top box-shadow-off"
    (click)="analyzeDataStructure()"
  >
    <ion-icon name="analytics-outline" slot="start"></ion-icon>
    Datenstruktur analysieren
  </ion-button>
  <ion-modal trigger="faq-open">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Datenabdeckung</ion-title>
          <ion-buttons slot="end">
            <ion-button class="ion-padding-horizontal" (click)="(false)"
              >Schließen</ion-button
            >
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        Wir beschränken die Anzeige aktuell auf Kryptowährungen, die wir selbst
        in regelmäßigen Abständen abrufen und speichern. Dadurch stellen wir
        schnellere und stabilere Kursdaten bereit. Nicht synchronisierte Assets
        werden ausgeblendet, bis sie in unseren Datenbestand aufgenommen sind.
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
